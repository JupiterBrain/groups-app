name: Flutter Desktop Installers

on:
  push:
    tags:
      - 'v*'   # nur bei Versionstags, z.B. v1.0.0
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0' # eure Flutter-Version

      - name: Install dependencies
        run: flutter pub get

      - name: Enable desktop platforms
        run: flutter config --enable-macos-desktop --enable-windows-desktop --enable-linux-desktop

      # Linux Build (.deb + AppImage)
      - name: Build Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev fakeroot dpkg-dev appstream
          flutter build linux --release
          # Installer bauen
          mkdir -p dist/linux
          cp -r build/linux/x64/release/bundle/* dist/linux/
          # .deb Paket mit fpm erzeugen
          gem install --no-document fpm
          fpm -s dir -t deb -n myapp -v $GITHUB_REF_NAME -C dist/linux .
          # AppImage via linuxdeploy
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          ./linuxdeploy-x86_64.AppImage --appdir dist/linux --output appimage

      # Windows Build (.msi / Installer)
      - name: Build Windows
        if: matrix.os == 'windows-latest'
        run: |
          flutter build windows --release
          # WiX Toolset installieren
          choco install wixtoolset --no-progress -y
          # MSI bauen (sehr vereinfacht, WiX XML n√∂tig)
          echo '<Wix>...</Wix>' > installer.wxs
          candle installer.wxs
          light installer.wixobj -o myapp.msi

      # macOS Build (.dmg)
      - name: Build macOS
        if: matrix.os == 'macos-latest'
        run: |
          flutter build macos --release
          mkdir -p dist/macos
          cp -r build/macos/Build/Products/Release/*.app dist/macos/
          hdiutil create -volname "MyApp" -srcfolder dist/macos -ov -format UDZO myapp.dmg

      # Upload Release
      - name: Upload installers to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.deb
            *.AppImage
            *.msi
            *.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}